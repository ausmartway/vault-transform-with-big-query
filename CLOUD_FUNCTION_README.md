# Vault Transform Cloud Function

This Cloud Function provides HTTP endpoints for encrypting and decrypting credit card numbers using HashiCorp Vault's Transform secrets engine with Format Preserving Encryption (FPE).

## Features

- **Format Preserving Encryption**: Credit card numbers maintain their format (16 digits)
- **BigQuery Integration**: Compatible with BigQuery Remote Functions
- **Production Ready**: Uses client tokens with minimal permissions
- **Health Checks**: Built-in health endpoint for monitoring
- **Error Handling**: Comprehensive error handling and logging

## Quick Start

### 1. Prerequisites

1. **HCP Vault Cluster**: You need an HCP Vault cluster (local Vault won't work with Cloud Functions)
2. **Vault Setup**: Run the setup script to configure Transform engine and generate client token:

   ```bash
   ./setup-transform.sh
   ```

3. **Environment Variables**: Configure your environment variables (see Configuration section)

### 2. Local Testing

Test the function locally before deploying:

```bash
# Start the function locally
./run-local.sh

# In another terminal, test the endpoints
python3 test-cloud-function.py
```

### 3. Deploy to Google Cloud

```bash
# Set your environment variables
export PROJECT_ID=your-gcp-project
export VAULT_ADDR=https://your-hcp-vault.vault.aws.hashicorp.cloud:8200
export VAULT_CLIENT_TOKEN=hvs.your-client-token-from-setup

# Deploy
./deploy/deploy_production.sh
```

## Configuration

### Environment Variables

| Variable | Description | Required | Example |
|----------|-------------|----------|---------|
| `VAULT_ADDR` | HCP Vault cluster URL | Yes | `https://vault-cluster.vault.aws.hashicorp.cloud:8200` |
| `VAULT_CLIENT_TOKEN` | Client token with transform permissions | Yes | `hvs.CAESIFgbWe...` |
| `VAULT_NAMESPACE` | Vault namespace | No | `admin` (default) |
| `VAULT_TRANSFORM_ROLE` | Transform role name | No | `creditcard-transform` (default) |
| `PROJECT_ID` | GCP Project ID | Yes | `my-gcp-project` |

### Client Token Generation

The `setup-transform.sh` script automatically generates a client token with minimal permissions:

```bash
./setup-transform.sh
```

Look for output like:

```text
Client token for credit card transform: hvs.CAESIFgbWevcE51Oqhmc718uQG0bbM4cXADHBdG6bsMAro2t...
```

## API Endpoints

### POST /encrypt

Encrypts credit card numbers using Vault Transform FPE.

**Request Format (BigQuery Remote Function):**
```json
{
  "requestId": "124ab1c",
  "caller": "//bigquery.googleapis.com/projects/myproject/jobs/...",
  "sessionUser": "user@company.com",
  "calls": [
    ["4111111111111111"],
    ["5555555555554444"]
  ]
}
```

**Response:**
```json
{
  "replies": [
    "3003078876416946",
    "4444333322221111"
  ]
}
```

### POST /decrypt

Decrypts encrypted credit card numbers back to plaintext.

**Request Format:**
```json
{
  "requestId": "124ab1c",
  "caller": "//bigquery.googleapis.com/projects/myproject/jobs/...",
  "sessionUser": "user@company.com",
  "calls": [
    ["3003078876416946"],
    ["4444333322221111"]
  ]
}
```

**Response:**
```json
{
  "replies": [
    "4111111111111111",
    "5555555555554444"
  ]
}
```

### GET /health

Health check endpoint.

**Response:**
```json
{
  "status": "healthy"
}
```

## BigQuery Integration

### Create Remote Functions

```sql
-- Encryption function
CREATE OR REPLACE FUNCTION `project.dataset.encrypt_credit_card`(credit_card STRING)
RETURNS STRING
REMOTE WITH CONNECTION `project.location.connection_name`
OPTIONS (
    endpoint = 'https://region-project.cloudfunctions.net/vault-transform-function/encrypt'
);

-- Decryption function
CREATE OR REPLACE FUNCTION `project.dataset.decrypt_credit_card`(encrypted_value STRING)
RETURNS STRING
REMOTE WITH CONNECTION `project.location.connection_name`
OPTIONS (
    endpoint = 'https://region-project.cloudfunctions.net/vault-transform-function/decrypt'
);
```

### Usage Examples

```sql
-- Encrypt credit card numbers
SELECT 
    customer_id,
    `project.dataset.encrypt_credit_card`(credit_card_number) AS encrypted_cc
FROM `project.dataset.payments`;

-- Decrypt (for authorized access only)
SELECT 
    customer_id,
    `project.dataset.decrypt_credit_card`(encrypted_credit_card) AS decrypted_cc
FROM `project.dataset.encrypted_payments`;
```

## Security Considerations

1. **Client Token**: Use the client token generated by `setup-transform.sh`, not the admin token
2. **Network Security**: Cloud Function communicates with HCP Vault over HTTPS
3. **Access Control**: Control access to decrypt operations through BigQuery IAM
4. **Logging**: All operations are logged for audit purposes
5. **Token Rotation**: Regularly rotate client tokens for security

## Monitoring

- **Health Checks**: Use `/health` endpoint for uptime monitoring
- **Cloud Function Logs**: Monitor through Google Cloud Console
- **Vault Audit Logs**: Monitor Vault operations through HCP Vault console

## Troubleshooting

### Common Issues

1. **"VAULT_CLIENT_TOKEN not set"**: Run `./setup-transform.sh` to generate a client token
2. **"Cannot connect to Vault"**: Ensure `VAULT_ADDR` points to HCP Vault, not localhost
3. **"Permission denied"**: Verify the client token has the correct policy attached
4. **"Function timeout"**: Check Vault connectivity and response times

### Debug Mode

Run locally with debug logging:
```bash
export VAULT_CLIENT_TOKEN=your-token
export VAULT_ADDR=your-hcp-vault-url
./run-local.sh
```

## Files

- `src/main.py` - Main Cloud Function code
- `src/requirements.txt` - Python dependencies
- `setup-transform.sh` - Vault setup and token generation
- `run-local.sh` - Local development server
- `test-cloud-function.py` - Test script
- `deploy/deploy_production.sh` - Production deployment script
- `sql/vault-transform-functions.sql` - BigQuery SQL examples
